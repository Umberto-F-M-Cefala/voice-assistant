<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#007bff">
<title>Assistente vocale di Umberto F. M. Cefal√†</title>
<link rel="manifest" href="manifest.json"> 
<style>
  /* ================= STILI (Mobile Friendly REM) ================= */
  html { font-size: 100%; box-sizing: border-box; }
  *, *:before, *:after { box-sizing: inherit; }
  
  body { 
    font-family: Arial, sans-serif; 
    text-align: center; 
    padding: 1.25rem; 
    margin: 0;
    background-color: #fff;
  }
  
  /* Contenitore Bottoni Mic/Stop */
  .controls-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem; 
      margin-bottom: 0.625rem; 
      flex-wrap: wrap; 
  }

  /* Icona stato dinamica */
  #statusIconContainer {
      font-size: 2rem;
      margin-top: 0.5rem;
      min-height: 2.5rem;
  }

  /* Elenco Sezioni */
  #sectionsList {
      font-size: 0.9rem;
      color: #333;
      background-color: #e9ecef;
      padding: 0.5rem;
      border-radius: 0.3125rem;
      margin-top: 0.625rem;
      margin-bottom: 0.5rem;
      line-height: 1.4;
      border: 1px solid #ced4da;
  }

  /* Stile Bottoni Principali */
  #micButton {
    font-size: 3.75rem; 
    cursor: pointer;
    border: 0.3125rem solid #007bff; 
    background-color: #f8f9fa; 
    border-radius: 3rem; 
    width: 7.5rem;  
    height: 7.5rem; 
    margin: 0.625rem; 
    transition: background-color 0.2s, border-color 0.2s; 
    display: flex; align-items: center; justify-content: center; padding: 0;
  }
  #micButton:hover { background-color: #e2e6ea; }
  #micButton.listening { border-color: #dc3545; background-color: #fdf5f6; }

  #stopButton {
    font-size: 3.75rem; 
    cursor: pointer;
    border: 0.1875rem solid #dc3545; 
    background: #fff;
    color: #dc3545;
    border-radius: 0.3125rem; 
    width: 7.5rem;  
    height: 7.5rem; 
    margin: 0.625rem; 
    display: flex; align-items: center; justify-content: center; padding: 0;
  }
  #stopButton:hover { background-color: #fdf5f6; }

  /* Output Text Box */
  #output { 
    margin-top: 0.5rem; 
    white-space: pre-wrap; 
    text-align: left; 
    background: #f4f4f4; 
    padding: 0.625rem; 
    border-radius: 0.3125rem; 
    min-height: 9.375rem; 
    border: 1px solid #ccc;
    font-size: 1rem;
  }
  
  input, select, button { margin: 0.3125rem; padding: 0.3125rem; font-size: 1rem; }
  .quick-times { margin: 0.625rem 0; }
  
  .time-selector {
      font-size: 1rem;
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      border: 2px solid #6c757d;
      background: #fff;
      border-radius: 0.3125rem;
      transition: background-color 0.2s, color 0.2s;
  }
  .time-selector:hover { background-color: #f8f9fa; }
  .time-selector.active { background-color: #007bff; color: #fff; border-color: #007bff; }
  
  #toggleButtons {
    cursor: pointer; margin-top: 0.625rem; padding: 0.625rem; width: 12.5rem;
    border: 2px solid #6c757d; background-color: #f8f9fa; border-radius: 0.3125rem;
    font-weight: bold; font-size: 1.125rem;
  }

  #extraButtons {
    display: none; border: 1px solid #ccc; border-radius: 0.3125rem; padding: 0.625rem;
    margin-top: 0.3125rem; max-width: 25rem; margin-left: auto; margin-right: auto;
    background-color: #fff;
  }
  
  @media (max-width: 480px) {
      #micButton, #stopButton { width: 6rem; height: 6rem; font-size: 3rem; }
      .time-selector { padding: 0.3rem 0.5rem; font-size: 0.9rem; }
  }
</style>
</head>
<body>

<div class="controls-container">
  <button id="micButton">üéôÔ∏è</button>  
  <button id="stopButton">‚èπÔ∏è</button>
</div>

<div class="quick-times">
    <strong>Preseleziona tempo:</strong><br>
    <button id="listen2s" class="time-selector">2s</button>
    <button id="listen4s" class="time-selector">4s</button>
    <button id="listen6s" class="time-selector">6s</button>
    <button id="listenCustom" class="time-selector active">Custom</button>
</div>
<label>Tempo Custom (ms): <input id="listeningTime" type="number" value="8000" style="width: 5rem;"></label>

<div id="sectionsList">Caricamento sezioni...</div>

<div id="statusIconContainer"></div>
<div id="output"></div>

<button id="toggleButtons">‚¨áÔ∏è Opzioni</button>
<div id="extraButtons">
  <button id="infoArchive">Informazioni Archivio</button> 
  <button id="infoCommands">Informazioni Comandi</button> 
  <button id="exportCommands">Esporta Archivio</button>
  <input type="file" id="importFile" accept=".json">
  <button id="resetArchive">Reset Archivio</button>
</div>

<script>
/* ================== CONFIG E STATO ================== */
const defaultArchive = { "conversazione": [] };
let archive = JSON.parse(localStorage.getItem('archive') || JSON.stringify(defaultArchive));

let appState = "IDLE"; 
let tempMemory = {}; 
let lastMainOutput = ""; 
let currentRecognition = null; 
let recognitionTimeout = null; // Nuova variabile per gestire il timer
let selectedListenMode = 'custom'; 
const SIGNATURE_TEXT = " - - testo trascritto dall'assistente vocale.";

// Vocabolario
const copyWords = ["copia", "salva", "trascrivi", "conserva", "riporta", "tieni"];
const affirmativeWords = ["s√¨", "va bene", "ok", "conferma", "esatto", "tutti", "tutto"];
const negativeWords = ["no", "cancella", "rimuovi", "annulla", "nessuno", "basta"];
const searchVerbs = ["cerca", "cerchi", "trova", "trovi", "dimmi", "dici"];
const searchPreps = ["in", "nelle", "nei", "nello", "nella", "su", "sulle", "sui", "sullo", "sulla"];
const readWords = ["leggi", "recita", "esponi"];
const randomWords = ["random", "a caso", "casuale"];

/* ================== MAPPA NUMERI ================== */
let textToNumMap = {
    "un": 1, "uno": 1, "primo": 1,
    "due": 2, "secondo": 2,
    "tre": 3, "terzo": 3,
    "quattro": 4, "quarto": 4,
    "cinque": 5, "quinto": 5,
    "sei": 6, "sesto": 6,
    "sette": 7, "settimo": 7,
    "otto": 8, "ottavo": 8,
    "nove": 9, "nono": 9,
    "dieci": 10, "decimo": 10,
    "cento": 100
};

function populateNumberMap() {
    const units = ["", "uno", "due", "tre", "quattro", "cinque", "sei", "sette", "otto", "nove"];
    const tens = ["", "dieci", "venti", "trenta", "quaranta", "cinquanta", "sessanta", "settanta", "ottanta", "novanta"];
    const specials = ["dieci", "undici", "dodici", "tredici", "quattordici", "quindici", "sedici", "diciassette", "diciotto", "diciannove"];

    for (let i = 1; i < 100; i++) {
        let word = "";
        if (i < 10) continue; 
        else if (i >= 10 && i < 20) word = specials[i - 10];
        else {
            let t = Math.floor(i / 10);
            let u = i % 10;
            let tenWord = tens[t];
            let unitWord = units[u];
            if ((u === 1 || u === 8) && tenWord.length > 0) tenWord = tenWord.substring(0, tenWord.length - 1);
            word = tenWord + unitWord;
        }
        textToNumMap[word] = i;
        if (word.endsWith("tre")) textToNumMap[word.replace("tre", "tr√©")] = i;
    }
}
populateNumberMap();

/* ================== GESTIONE UI SEZIONI ================== */
function updateSectionList() {
    const listDiv = document.getElementById('sectionsList');
    const sections = Object.keys(archive);
    
    if (sections.length === 0) {
        listDiv.textContent = "Elenco delle sezioni: Nessuna sezione presente";
        return;
    }

    const labels = sections.map(sec => {
        const count = Array.isArray(archive[sec]) ? archive[sec].length : 0;
        return `${sec} (n. ${count})`;
    });

    listDiv.textContent = "Elenco delle sezioni: " + labels.join(" - ");
}
updateSectionList();

/* ================== HELPER VISUALIZZAZIONE ================== */
function setStatusIcon(type) {
    const container = document.getElementById('statusIconContainer');
    let icon = "";
    let label = "";
    switch(type) {
        case 'search': icon = "üîç"; label = "Ricerca"; break;
        case 'conversation': icon = "üí¨"; label = "Conversazione"; break;
        case 'random': icon = "üìñ"; label = "Lettura Random"; break;
        case 'transcription': icon = "ü™∂"; label = "Trascrizione"; break;
        default: icon = ""; 
    }
    container.innerHTML = icon ? `${icon} <span style="font-size:1rem; vertical-align:middle">${label}</span>` : "";
}

function appendOutput(text) {
  const outDiv = document.getElementById('output');
  outDiv.textContent += text + "\n";
  outDiv.scrollTop = outDiv.scrollHeight;
}

function displayEntryDetails(item) {
    const out = `----------------
ricerca: ${item.trigger || "N/A"}
contenuto: ${item.output || "N/A"}
tag: ${item.tag || "-"}
titolo: ${item.meta_title || "-"}
autore: ${item.meta_author || "-"}
----------------`;
    appendOutput(out);
}

/* ================== FUNZIONI VOCALI ================== */
function speak(text, onEndCallback = null, isEntry = false) {
  speechSynthesis.cancel(); 
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'it-IT';
  if (!isEntry) appendOutput("Bot: " + text);
  if (onEndCallback) utter.onend = onEndCallback;
  speechSynthesis.speak(utter);
}

function speakEntry(item) {
    speak(item.output, null, true);
}

/* ================== CONTROLLI PRINCIPALI ================== */

function activateListening() {
    if (speechSynthesis.speaking) speechSynthesis.cancel();

    // NUOVO: Se stiamo gi√† ascoltando, ferma e invia subito
    if (currentRecognition) {
        currentRecognition.stop(); 
        if (recognitionTimeout) clearTimeout(recognitionTimeout); // Ferma il timer automatico
        return;
    }

    let listeningTime;
    if (selectedListenMode === '2s') listeningTime = 2000;
    else if (selectedListenMode === '4s') listeningTime = 4000;
    else if (selectedListenMode === '6s') listeningTime = 6000;
    else listeningTime = parseInt(document.getElementById('listeningTime').value) || 8000;
    
    startListening(handleSpeech, listeningTime);
}

document.getElementById('micButton').onclick = activateListening;

// NUOVO: Shortcut Ctrl + Alt + v
document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'v') {
        e.preventDefault(); // Previene azioni default del browser
        activateListening();
    }
});

function setListenMode(mode) {
    selectedListenMode = mode;
    document.querySelectorAll('.time-selector').forEach(btn => btn.classList.remove('active'));
    if (mode === '2s') document.getElementById('listen2s').classList.add('active');
    else if (mode === '4s') document.getElementById('listen4s').classList.add('active');
    else if (mode === '6s') document.getElementById('listen6s').classList.add('active');
    else document.getElementById('listenCustom').classList.add('active');
}

document.getElementById('listen2s').onclick = () => setListenMode('2s');
document.getElementById('listen4s').onclick = () => setListenMode('4s');
document.getElementById('listen6s').onclick = () => setListenMode('6s');
document.getElementById('listenCustom').onclick = () => setListenMode('custom');

document.getElementById('stopButton').onclick = () => {
  speechSynthesis.cancel(); 
  if (currentRecognition) {
      currentRecognition.stop(); 
      currentRecognition = null;
  }
  if (recognitionTimeout) clearTimeout(recognitionTimeout);
  document.getElementById('micButton').classList.remove('listening');
  
  appState = "IDLE";
  tempMemory = {};
  lastMainOutput = ""; 
  document.getElementById('output').textContent = ""; 
  setStatusIcon("");
};

function startListening(callback, duration) {
  if (!('webkitSpeechRecognition' in window)) {
    appendOutput("ERRORE: Riconoscimento vocale non supportato.");
    return;
  }
  if (currentRecognition) currentRecognition.stop();
  
  document.getElementById('micButton').classList.add('listening');
  const recognition = new webkitSpeechRecognition();
  currentRecognition = recognition; 
  recognition.lang = "it-IT";
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  
  recognition.onresult = (event) => callback(event.results[0][0].transcript.toLowerCase());
  recognition.onerror = (event) => { appendOutput("Errore: " + event.error); appState = "IDLE"; };
  recognition.onend = () => {
    currentRecognition = null; 
    document.getElementById('micButton').classList.remove('listening');
  };
  
  recognition.start();
  appendOutput("...In ascolto... (Premi di nuovo per inviare subito)");
  
  // Salva il timeout per poterlo cancellare se si preme Stop o il tasto Mic
  recognitionTimeout = setTimeout(() => { 
      if (currentRecognition === recognition) recognition.stop(); 
  }, duration);
}

/* ================== LOGICA CENTRALE ================== */

function handleSpeech(text) {
  appendOutput("Tu: " + text);

  if (appState === "AWAITING_SEARCH_CHOICE") {
      handleSearchChoice(text);
      return;
  }

  // 1. COMANDI DI SISTEMA
  if (text === "ripeti") {
      if (lastMainOutput) speak("Ripeto: " + lastMainOutput);
      else speak("Non c'√® nulla da ripetere.");
      return;
  }

  // 2. COPIA DIRETTA / TRASCRIZIONE
  const commandWord = copyWords.find(w => text.startsWith(w));
  if (commandWord) {
      setStatusIcon('transcription');
      handleCopyCommand(text, commandWord);
      return;
  }

  // 3. LETTURA LOOP / RANDOM
  if (readWords.some(w => text.startsWith(w))) {
      setStatusIcon('random');
      if (handleRead(text)) return;
  }

  // 4. RICERCA METADATI
  if (text.includes("autore") || text.includes("titolo")) {
      setStatusIcon('search');
      let type = text.includes("autore") ? "meta_author" : "meta_title";
      let query = text.split(text.includes("autore") ? "autore" : "titolo")[1].trim();
      if (query) {
          handleMetadataSearch(type, query);
          return;
      }
  }

  // 5. RICERCA AVANZATA
  const searchPattern = new RegExp(`(${searchVerbs.join('|')})\\s+(${searchPreps.join('|')})\\s+([a-zA-Z0-9_]+)\\s+(.*)`, 'i');
  const match = text.match(searchPattern);
  if (match) {
      setStatusIcon('search');
      const section = match[3].toLowerCase();
      const query = match[4].trim();
      if (archive[section]) {
          handleAdvancedSearch(section, query);
          return;
      } else {
          speak(`La sezione "${section}" non esiste.`);
          return;
      }
  }

  // 6. RICERCA DIRETTA
  if (archive.conversazione) {
      for (let cmd of archive.conversazione) {
          if (text.includes(cmd.trigger.toLowerCase())) {
              setStatusIcon('conversation');
              displayEntryDetails(cmd);
              speakEntry(cmd);
              lastMainOutput = cmd.output; 
              return;
          }
      }
  }

  // 7. NON RICONOSCIUTO
  lastMainOutput = text;
  setStatusIcon('');
  appendOutput("(Testo non riconosciuto. D√¨ 'Salva' o 'Ripeti')");
}

/* ================== IMPLEMENTAZIONE FUNZIONI ================== */

function parseNumber(text) {
    const digitMatch = text.match(/\d+/);
    if (digitMatch) return parseInt(digitMatch[0]);
    for (const [key, val] of Object.entries(textToNumMap)) {
        if (text.includes(key)) return val;
    }
    return null;
}

function handleCopyCommand(text, commandWord) {
    let content = text.substring(commandWord.length).trim();
    
    // NUOVO: Logica firma invertita (Default: NO firma)
    let useSignature = false;
    if (content.includes("con firma") || content.includes("aggiungi firma") || text.includes("con firma")) {
        useSignature = true;
        content = content.replace("con firma", "").replace("aggiungi firma", "").trim();
    }
    
    if (!content && lastMainOutput) content = lastMainOutput;
    else if (!content) { speak("Non c'√® nulla da salvare."); return; }

    // NUOVO: Sostituzione Punteggiatura
    // virgola -> , | punto -> . | due punti -> : | a capo -> \n
    content = content.replace(/\bvirgola\b/gi, ", ")
                     .replace(/\bpunto\b/gi, ". ")
                     .replace(/\bdue punti\b/gi, ": ")
                     .replace(/\ba capo\b/gi, "\n");

    // Pulizia spazi doppi generati
    content = content.replace(/\s\s+/g, ' ').trim();
    // Fix per spazi prima della punteggiatura (es: "parola ,")
    content = content.replace(/\s+([,.:])/g, '$1');

    const finalString = useSignature ? content + SIGNATURE_TEXT : content;
    
    navigator.clipboard.writeText(finalString).then(() => {
        speak(useSignature ? "Salvato con firma." : "Salvato.");
        appendOutput(`üìã Appunti: "${finalString}"`);
        lastMainOutput = content;
    });
}

function handleRead(text) {
    if (text.includes("casuale")) {
        const allEntries = [].concat(...Object.values(archive));
        const item = allEntries[Math.floor(Math.random() * allEntries.length)];
        displayEntryDetails(item);
        speakEntry(item);
        return true;
    }
    
    const sectionMatch = Object.keys(archive).find(sec => text.includes(sec));
    if (sectionMatch) {
        const list = archive[sectionMatch];
        if (!list || list.length === 0) {
            speak(`La sezione ${sectionMatch} √® vuota.`);
            return true;
        }
        const startIndex = Math.floor(Math.random() * list.length);
        speak(`Leggo ${sectionMatch} partendo dall'elemento ${startIndex + 1}.`);
        speechSynthesis.cancel();
        for (let i = 0; i < list.length; i++) {
            const idx = (startIndex + i) % list.length;
            const item = list[idx];
            const utter = new SpeechSynthesisUtterance(item.output);
            utter.lang = 'it-IT';
            utter.onstart = () => displayEntryDetails(item);
            speechSynthesis.speak(utter);
        }
        return true;
    }
    return false;
}

function handleAdvancedSearch(section, query) {
    const list = archive[section];
    const isRandom = randomWords.some(w => query.includes(w));
    if (isRandom) {
        const item = list[Math.floor(Math.random() * list.length)];
        displayEntryDetails(item);
        speakEntry(item);
        return;
    }
    const results = list.filter(c => 
        (c.trigger && c.trigger.toLowerCase().includes(query)) || 
        (c.output && c.output.toLowerCase().includes(query))
    );
    processSearchResults(results, `in ${section} per "${query}"`);
}

function handleMetadataSearch(type, query) {
    const all = [].concat(...Object.values(archive));
    const results = all.filter(c => c[type] && c[type].toLowerCase().includes(query));
    const vocalLabel = type === "meta_author" ? "autore" : 
                       type === "meta_title" ? "titolo" : type;
    processSearchResults(results, `per ${vocalLabel} "${query}"`);
}

function processSearchResults(results, context) {
    if (results.length === 0) {
        speak("Nessun risultato " + context);
    } else if (results.length === 1) {
        displayEntryDetails(results[0]);
        speakEntry(results[0]);
        lastMainOutput = results[0].output;
    } else {
        let listStr = `Ho trovato ${results.length} risultati: `;
        results.forEach((r, i) => {
            const title = r.meta_title || r.trigger || "Elemento";
            listStr += `${i + 1}: ${title}; `; 
        });
        appendOutput("Risultati multipli:\n" + listStr);
        speak(listStr + " Scegli il numero, oppure 'tutti' o 'nessuno'.");
        tempMemory.searchResults = results;
        appState = "AWAITING_SEARCH_CHOICE";
    }
}

function handleSearchChoice(text) {
    if (negativeWords.some(w => text.includes(w))) {
        speak("Annullato.");
        appState = "IDLE";
        tempMemory = {};
        return;
    }

    const results = tempMemory.searchResults;
    if (text.includes("tutti") || text.includes("tutto")) {
        speak(`Leggo tutti i ${results.length} risultati.`);
        speechSynthesis.cancel();
        results.forEach((item, i) => {
            const intro = new SpeechSynthesisUtterance(`Numero ${i+1}.`);
            intro.lang = 'it-IT';
            speechSynthesis.speak(intro);
            const utter = new SpeechSynthesisUtterance(item.output);
            utter.lang = 'it-IT';
            utter.onstart = () => displayEntryDetails(item);
            speechSynthesis.speak(utter);
        });
        appState = "IDLE";
        return;
    }
    
    const choiceNum = parseNumber(text);
    if (choiceNum !== null && choiceNum > 0 && choiceNum <= results.length) {
        const item = results[choiceNum - 1];
        displayEntryDetails(item);
        speakEntry(item);
        lastMainOutput = item.output;
        appState = "IDLE";
    } else {
        speak("Numero non valido. Riprova o d√¨ annulla.");
    }
}

/* ================== GESTIONE EXTRA UI ================== */

document.getElementById('toggleButtons').onclick = () => {
    const extra = document.getElementById('extraButtons');
    const btn = document.getElementById('toggleButtons');
    if (extra.style.display === 'none' || !extra.style.display) {
        extra.style.display = 'block';
        btn.textContent = '‚¨ÜÔ∏è Chiudi Opzioni';
    } else {
        extra.style.display = 'none';
        btn.textContent = '‚¨áÔ∏è Opzioni';
    }
};

document.getElementById('infoArchive').onclick = () => {
    const txt = `INFO ARCHIVIO
-------------
Esempio di struttura JSON valida con 2 sezioni:
{
  "conversazione": [
    { "trigger": "ciao", "output": "Benvenuto.", "tag": "saluti", "meta_title": "", "meta_author": "" },
    { "trigger": "aiuto", "output": "Chiedimi di cercare.", "tag": "info", "meta_title": "", "meta_author": "" }
  ],
  "poesie": [
    { "trigger": "infinito", "output": "Sempre caro mi fu...", "tag": "leopardi", "meta_title": "L'infinito", "meta_author": "Leopardi" },
    { "trigger": "veglia", "output": "Un'intera nottata...", "tag": "ungaretti", "meta_title": "Veglia", "meta_author": "Ungaretti" }
  ]
}`;
    document.getElementById('output').textContent = txt;
};

document.getElementById('infoCommands').onclick = () => {
    const txt = `GUIDA COMANDI VOCALI
--------------------
1. COMANDI BASE:
   - "Ripeti": Ripete l'ultimo output.
   - "Stop": Resetta tutto.
   - Shortcut "Ctrl+Alt+v": Avvia/Ferma ascolto.

2. SALVATAGGIO AVANZATO:
   - "Salva [testo]": Copia (Default: NO firma).
   - "Salva [testo] con firma": Aggiunge firma.
   - Punteggiatura automatica: D√¨ "virgola", "punto", "due punti", "a capo".

3. INTERAZIONE DIRETTA (Sezione 'Conversazione'):
   - D√¨ solo la parola chiave (es. "Ciao").

4. RICERCA AVANZATA:
   - "Cerca in [sezione] [parola]".
   - "...autore [nome]" / "...titolo [titolo]".

5. LETTURA:
   - "Leggi [sezione]" (sequenziale circolare).
   - "Leggi casuale [tag]".
`;
    document.getElementById('output').textContent = txt;
};

document.getElementById('exportCommands').onclick = () => {
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(archive, null, 2));
  const a = document.createElement('a');
  a.href = dataStr;
  a.download = "archivio_assistente.json";
  a.click();
};

document.getElementById('importFile').onchange = (e) => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const json = JSON.parse(ev.target.result);
      for(let k in json) {
          if (!archive[k]) archive[k] = [];
          json[k].forEach(item => archive[k].push(item));
      }
      localStorage.setItem('archive', JSON.stringify(archive));
      updateSectionList(); 
      appendOutput(`Bot: Importazione completata.`);
    } catch(err) { appendOutput("Errore JSON: " + err.message); }
  };
  reader.readAsText(file);
};

document.getElementById('resetArchive').onclick = () => {
  if(confirm("Reset archivio?")) {
    archive = JSON.parse(JSON.stringify(defaultArchive));
    localStorage.setItem('archive', JSON.stringify(archive));
    updateSectionList(); 
    appendOutput("Bot: Archivio resettato.");
  }
};
</script>
</body>
</html>
